define(["jquery","core/notification"],function(a,b){"use strict";var c={id:0,debugjs:!1,hasHorizontalRuler:!0,background:""},d=function(a){var b,d;for(b in c)c.hasOwnProperty(b)&&a.hasOwnProperty(b)&&(d=typeof c[b],"boolean"===d?c[b]=Boolean(a[b]):"number"===d?c[b]=Number(a[b]):"string"===d&&(c[b]=String(a[b])))},e={},f=0,g=0,h=!0,i=function(a){if(a)for(var b in console)"function"==typeof console[b]&&(e[b]=console[b].bind(window.console));else for(var b in console)"function"==typeof console[b]&&(e[b]=function(){})},j=null,k={canvasWidth:800,canvasHeight:500,defaultShaperect:{width:70,height:70,left:200,top:50,angle:0,fill:"#ffb628"},defaultShapecircle:{radius:40,left:200,top:50,fill:"#b3cc2b"},defaultShapetriangle:{top:50,left:200,width:70,height:70,fill:"#0081b4"},defaultShapetextbox:{top:50,left:200,fill:"#0081b4"},loadHistory:function(){a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"load_history",data:{id:c.id}},dataType:"json",success:function(b){e.log(b),b.success&&a("#history").html(b.html)},error:function(a){e.error(a.responseText),b.addNotification({message:a.responseText,type:"error"})}})},saveCanvasAjax:function(){fabric.Canvas.supports("toDataURL")?a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"save_canvas",data:{id:c.id,status:"final",canvas_data:j.toDataURL({multiplier:1,format:"png"}),json_data:JSON.stringify(j)}},dataType:"json",success:function(a){e.log(a),a.success?(b.addNotification({message:M.util.get_string("javascript:updated","mod_gcanvas"),type:"success"}),k.loadHistory()):b.addNotification({message:a.error,type:"error"})},error:function(a){e.error(a.responseText),b.addNotification({message:a.responseText,type:"error"})}}):b.addNotification({message:"This browser doesn't provide means to serialize canvas to an image",type:"error"})},deleteSelectedCanvasItems:function(){try{var a=j.getActiveObjects();if(a.length){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];if(void 0!==c.id&&"ruler"===c.id){e.log("Ruler: Not removable!");continue}j.remove(c)}j.discardActiveObject().renderAll()}else e.log("Selection empty")}catch(d){e.error("Nothing selected",d)}},loadDynamicToolbarMappingShapes:function(){a("#toolbar .icon[data-element-type]").on("click",function(){var b,c=a(this).data("element-type");try{j.discardActiveObject()}catch(d){}var f="defaultShape"+c.toLowerCase();e.log("Search for shape: "+f),k.hasOwnProperty(f)?(e.log("Shape found"),b="Textbox"===c?new fabric[c]("DEMO",k[f]):new fabric[c](k[f]),j.add(b),j.setActiveObject(b)):e.error("Shape not found!"),j.renderAll()})},loadColorPicker:function(){a("#colorpicker").spectrum({showPalette:!0,palette:[],showSelectionPalette:!0,selectionPalette:["red","green","blue","orange"],flat:!1,change:function(a){e.log("change color"),k.setColor(a)}}).on("dragstart.spectrum , dragstop.spectrum",function(a,b){e.log("change color - dragstop - dragstart"),k.setColor(b)})},loadEmojiCsv:function(a){e.log("loadEmojiCsv : ",a),fabric.Image.fromURL(a.replace(".png",".svg"),function(a){a.set({height:500,width:500,left:150,top:100,angle:0,centerTransform:!0}).scale(.4).setCoords(),j.add(a),j.setActiveObject(a)})},deleteAttempt:function(d){e.log("Delete",d),b.confirm(M.util.get_string("javascript:confirm_title","mod_gcanvas"),M.util.get_string("javascript:confirm_desc","mod_gcanvas"),M.util.get_string("javascript:yes","mod_gcanvas"),M.util.get_string("javascript:no","mod_gcanvas"),function(){a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"delete_attempt",data:{id:c.id,attempt_id:d.data("id")}},dataType:"json",success:function(a){e.log(a),a.success?k.loadHistory():b.addNotification({message:a.error,type:"error"})},error:function(a){e.error(a.responseText),b.addNotification({message:a.responseText,type:"error"})}})})},restoreAttempt:function(b){e.log("Restore",b),a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"get_attempt",data:{id:c.id,attempt_id:b.data("id")}},dataType:"json",success:function(a){e.log(a),a.success&&(h=!1,j.loadFromJSON(a.record.json_data,j.renderAll.bind(j)),setTimeout(function(){h=!0},1e3))}})},showFileuploader:function(b){a("#canvas-filepicker-form-"+b).toggle()},setBackgroundImage:function(){""!==c.background&&fabric.Image.fromURL(c.background,function(a){j.setBackgroundImage(a,j.renderAll.bind(j),{scaleX:j.width/a.width,scaleY:j.height/a.height})})},addUserImage:function(){var b={id:c.id},d=a("#canvas-filepicker-form-student_image form").serializeArray();a.each(d,function(a,c){b[c.name]=c.value}),a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"upload_images",data:b},dataType:"json",success:function(b){e.log(b),b.success&&k.addImageFromUrl(b.image),a("#canvas-filepicker-form-student_image").hide()}})},addImageFromUrl:function(a){fabric.Image.fromURL(a,function(a){a.set({left:150,top:100,angle:0,centerTransform:!0}).setCoords();var b=j.getWidth()/3;a.width>b&&a.scaleToWidth(b),j.add(a),j.setActiveObject(a)})},selectToolbarImage:function(){var b=a("#image-picker");return b.is(":visible")?void b.hide():(b.show(),void a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"get_toolbar_images",data:{id:c.id}},dataType:"json",success:function(c){if(e.log(c),c.success){var d='<ul class="list-group">';a.each(c.images,function(a,b){d+='<li class="toolbar-image" rel="'+a+'"><img  alt="" src="'+b+'" class="img-thumbnail"></li>'}),d+="</ul>",b.html(d)}}}))},undo:function(){if(0!==f)try{var a=localStorage.getItem("buffer_"+f);j.loadFromJSON(a,j.renderAll.bind(j)),localStorage.removeItem("buffer_"+f),f--}catch(b){e.log(b)}},loadToolbar:function(){this.setBackgroundImage(),this.loadDynamicToolbarMappingShapes(),this.loadColorPicker(),a("#clear").on("click",function(){j.clear(),c.hasHorizontalRuler&&k.addHorizontalRuler(),k.setBackgroundImage()}),a("#arrow i").on("click",function(){k.loadArrowToCanvas()}),a("#trash i").on("click",function(){k.deleteSelectedCanvasItems()}),a("#smiley i").on("click",function(){k.loadEmojiPicker()}),a("#undo").on("click",function(){h=!1,k.undo(),setTimeout(function(){h=!0},500)}),a("#add-image i").on("click",function(){k.showFileuploader("student_image")}),a("#select-a-image i").on("click",function(){k.selectToolbarImage()}),a("#image-picker ").on("click","img",function(){k.addImageFromUrl(a(this).attr("src")),a("#image-picker").hide()}),a("#save-canvas").on("click",function(){k.saveCanvasAjax()}),a("#show-help").on("click",function(){a("#dialog-help").show()}),a("#dialog-help").on("click",function(){a("#dialog-help").hide()}),a("#history").on("click",".delete",function(b){b.preventDefault(),k.deleteAttempt(a(this))}).on("click",".restore",function(b){b.preventDefault(),k.restoreAttempt(a(this))}),a("#emoji-picker").on("click","img",function(){k.loadEmojiCsv(a(this).attr("src")),a("#emoji-picker").hide()}),a("#change_background").on("click",function(){k.showFileuploader("background")}),a("#add_toolbar_images").on("click",function(){k.showFileuploader("toolbar_shape")}),a("#canvas-filepicker-form-student_image").on("click","#id_submitbutton",function(a){a.preventDefault(),k.addUserImage()}),a(".dialog").on("click",".btn-secondary",function(b){b.preventDefault(),e.log("Cancel"),a(".dialog").hide()})},loadEmojiPicker:function(){var b=a("#emoji-picker");return""!==b.html()?(e.log("Toggle emoji"),void b.toggle()):void a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"emoji",data:{id:c.id}},dataType:"json",success:function(a){e.log(a),a.success&&b.html(a.html).show()}})},loadArrowToCanvas:function(){fabric.loadSVGFromURL("pix/arrow.svg",function(a,b){var c=fabric.util.groupSVGElements(a,b);j.add(c.scale(.1)).centerObject(c).renderAll(),c.setCoords(),j.setActiveObject(c)})},setColor:function(a){var b=a.toHexString(),c=j.getActiveObjects();if(c){for(var d in c)if(c.hasOwnProperty(d)){var f=c[d];if(f.hasOwnProperty("id")&&"ruler"===f.id)continue;f.set("fill",b)}j.renderAll()}else e.log("No active items")},preventMovingOutOfCanvas:function(){j.on("object:moving",function(a){var b=a.target;b.currentHeight>b.canvas.height||b.currentWidth>b.canvas.width||(b.setCoords(),(b.getBoundingRect().top<0||b.getBoundingRect().left<0)&&(b.top=Math.max(b.top,b.top-b.getBoundingRect().top),b.left=Math.max(b.left,b.left-b.getBoundingRect().left)),(b.getBoundingRect().top+b.getBoundingRect().height>b.canvas.height||b.getBoundingRect().left+b.getBoundingRect().width>b.canvas.width)&&(b.top=Math.min(b.top,b.canvas.height-b.getBoundingRect().height+b.top-b.getBoundingRect().top),b.left=Math.min(b.left,b.canvas.width-b.getBoundingRect().width+b.left-b.getBoundingRect().left)))})},keyboardActions:function(){a(document).keydown(function(a){switch(e.log("keypress",a.which),a.which){case 46:k.deleteSelectedCanvasItems()}})},init:function(){this.__canvas=j=new fabric.Canvas("sketch"),a("body").on("contextmenu","canvas , img",function(){return!1}),j.setHeight(this.canvasHeight),j.setWidth(this.canvasWidth),j.on({"selection:created":this.onchange,"selection:updated":this.onchange,"object:added":this.addToCache,"object:removed":this.addToCache,"object:modified":this.addToCache}),localStorage.clear(),this.preventMovingOutOfCanvas(),this.loadToolbar(),c.hasHorizontalRuler&&this.addHorizontalRuler(),this.loadHistory(),this.keyboardActions()},addToCache:function(){e.log("history"),k.addCanvasToCacheBuffer()},addCanvasToCacheBuffer:function(){h&&(clearTimeout(g),setTimeout(function(){try{f++,localStorage.setItem("buffer_"+f,JSON.stringify(j))}catch(a){e.log(a)}},500))},addHorizontalRuler:function(){var b=new fabric.Rect({width:this.canvasWidth,height:2,id:"ruler",left:0,top:410,angle:0,fill:"#8b58a1"});b.flipY=!1,b.lockMovementX=!0,b.lockScalingX=!0,b.lockScalingY=!0,b.lockUniScaling=!0,b.lockRotation=!0,j.add(b),j.renderAll(),a(document).keydown(function(a){switch(a.which){case 38:b.top=b.top-10,j.renderAll();break;case 40:b.top=b.top+10,j.renderAll();break;default:return}a.preventDefault()})},onchange:function(b){b.target.hasOwnProperty("id")&&"ruler"===b.target.id||a("#colorpicker").spectrum("set",b.target.fill)}};return{initialise:function(b){a.getScript(M.cfg.wwwroot+"/mod/gcanvas/javascript/spectrum.js").done(function(){d(b),i(c.debugjs),a.noConflict(),a(document).ready(function(){e.log("Canvas Module v1.2"),k.init()})}).fail(function(a,b,c){e.log(a),e.log(b),e.log(c)})}}});