function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("mod_gcanvas/canvas",["jquery","core/notification"],function(a,b){'use strict';var c={id:0,debugjs:!1,hasHorizontalRuler:!0,background:""},d=function(a){var b,d;for(b in c){if(c.hasOwnProperty(b)&&a.hasOwnProperty(b)){d=_typeof(c[b]);if("boolean"===d){c[b]=!!a[b]}else if("number"===d){c[b]=+a[b]}else if("string"===d){c[b]=a[b]+""}}}},f={},g=0,h=!0,i=function(a){if(a){for(var b in console){if("function"==typeof console[b]){f[b]=console[b].bind(window.console)}}}else{for(var c in console){if("function"==typeof console[c]){f[c]=function(){}}}}},j=null,k={canvasWidth:800,canvasHeight:500,defaultShaperect:{width:70,height:70,left:200,top:50,angle:0,fill:"#ffb628"},defaultShapecircle:{radius:40,left:200,top:50,fill:"#b3cc2b"},defaultShapetriangle:{top:50,left:200,width:70,height:70,fill:"#0081b4"},defaultShapetextbox:{top:50,left:200,fill:"#0081b4"},loadHistory:function loadHistory(){a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"load_history",data:{id:c.id}},dataType:"json",success:function success(b){f.log(b);if(b.success){a("#history").html(b.html)}},error:function error(a){f.error(a.responseText);b.addNotification({message:a.responseText,type:"error"})}})},saveCanvasAjax:function saveCanvasAjax(){if(!fabric.Canvas.supports("toDataURL")){b.addNotification({message:"This browser doesn't provide means to serialize canvas to an image",type:"error"})}else{a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"save_canvas",data:{id:c.id,status:"final",canvas_data:j.toDataURL({multiplier:1,format:"png"}),json_data:JSON.stringify(j)}},dataType:"json",success:function success(a){f.log(a);if(a.success){b.addNotification({message:M.util.get_string("javascript:updated","mod_gcanvas"),type:"success"});k.loadHistory()}else{b.addNotification({message:a.error,type:"error"})}},error:function error(a){f.error(a.responseText);b.addNotification({message:a.responseText,type:"error"})}})}},deleteSelectedCanvasItems:function deleteSelectedCanvasItems(){try{var a=j.getActiveObjects();if(0>=a.length){f.log("Selection empty");return}for(var b in a){if(a.hasOwnProperty(b)){var c=a[b];if(c.id!==void 0&&"ruler"===c.id){f.log("Ruler: Not removable!");continue}j.remove(c)}}j.discardActiveObject().renderAll()}catch(a){f.error("Nothing selected",a)}},loadDynamicToolbarMappingShapes:function loadDynamicToolbarMappingShapes(){a("#toolbar .icon[data-element-type]").on("click",function(){var b,c=a(this).data("element-type");try{j.discardActiveObject()}catch(a){}var d="defaultShape"+c.toLowerCase();f.log("Search for shape: "+d);if(k.hasOwnProperty(d)){f.log("Shape found");if("Textbox"===c){b=new fabric[c]("DEMO",k[d])}else{b=new fabric[c](k[d])}j.add(b);j.setActiveObject(b)}else{f.error("Shape not found!")}j.renderAll()})},loadColorPicker:function loadColorPicker(){a("#colorpicker").spectrum({showPalette:!0,palette:[],showSelectionPalette:!0,selectionPalette:["red","green","blue","orange"],flat:!1,change:function change(a){f.log("change color");k.setColor(a)}}).on("dragstart.spectrum , dragstop.spectrum",function(a,b){f.log("change color - dragstop - dragstart");k.setColor(b)})},loadEmojiCsv:function loadEmojiCsv(a){f.log("loadEmojiCsv : ",a);fabric.Image.fromURL(a.replace(".png",".svg"),function(a){a.set({height:500,width:500,left:150,top:100,angle:0,centerTransform:!0}).scale(.4).setCoords();j.add(a);j.setActiveObject(a)})},deleteAttempt:function deleteAttempt(d){f.log("Delete",d);b.confirm(M.util.get_string("javascript:confirm_title","mod_gcanvas"),M.util.get_string("javascript:confirm_desc","mod_gcanvas"),M.util.get_string("javascript:yes","mod_gcanvas"),M.util.get_string("javascript:no","mod_gcanvas"),function(){a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"delete_attempt",data:{id:c.id,attempt_id:d.data("id")}},dataType:"json",success:function success(a){f.log(a);if(a.success){k.loadHistory()}else{b.addNotification({message:a.error,type:"error"})}},error:function error(a){f.error(a.responseText);b.addNotification({message:a.responseText,type:"error"})}})})},restoreAttempt:function restoreAttempt(b){f.log("Restore",b);a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"get_attempt",data:{id:c.id,attempt_id:b.data("id")}},dataType:"json",success:function success(a){f.log(a);if(a.success){h=!1;j.loadFromJSON(a.record.json_data,j.renderAll.bind(j));setTimeout(function(){h=!0},1e3)}}})},showFileuploader:function showFileuploader(b){a("#canvas-filepicker-form-"+b).toggle()},setBackgroundImage:function setBackgroundImage(){if(""!==c.background){fabric.Image.fromURL(c.background,function(a){j.setBackgroundImage(a,j.renderAll.bind(j),{scaleX:j.width/a.width,scaleY:j.height/a.height})})}},addUserImage:function addUserImage(){var b={id:c.id},d=a("#canvas-filepicker-form-student_image form").serializeArray();a.each(d,function(a,c){b[c.name]=c.value});a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"upload_images",data:b},dataType:"json",success:function success(b){f.log(b);if(b.success){k.addImageFromUrl(b.image)}a("#canvas-filepicker-form-student_image").hide()}})},addImageFromUrl:function addImageFromUrl(a){fabric.Image.fromURL(a,function(a){a.set({left:150,top:100,angle:0,centerTransform:!0}).setCoords();var b=j.getWidth()/3;if(a.width>b){a.scaleToWidth(b)}j.add(a);j.setActiveObject(a)})},selectToolbarImage:function selectToolbarImage(){var b=a("#image-picker");if(b.is(":visible")){b.hide();return}b.show();a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"get_toolbar_images",data:{id:c.id}},dataType:"json",success:function success(c){f.log(c);if(c.success){var d="<ul class=\"list-group\">";a.each(c.images,function(a,b){d+="<li class=\"toolbar-image\" rel=\""+a+"\"><img  alt=\"\" src=\""+b+"\" class=\"img-thumbnail\"></li>"});d+="</ul>";b.html(d)}}})},undo:function undo(){if(0===g){return}try{var a=localStorage.getItem("buffer_"+g);j.loadFromJSON(a,j.renderAll.bind(j));localStorage.removeItem("buffer_"+g);g--}catch(a){f.log(a)}},loadToolbar:function loadToolbar(){this.setBackgroundImage();this.loadDynamicToolbarMappingShapes();this.loadColorPicker();a("#clear").on("click",function(){j.clear();if(c.hasHorizontalRuler){k.addHorizontalRuler()}k.setBackgroundImage()});a("#arrow i").on("click",function(){k.loadArrowToCanvas()});a("#trash i").on("click",function(){k.deleteSelectedCanvasItems()});a("#smiley i").on("click",function(){k.loadEmojiPicker()});a("#undo").on("click",function(){h=!1;k.undo();setTimeout(function(){h=!0},500)});a("#add-image i").on("click",function(){k.showFileuploader("student_image")});a("#select-a-image i").on("click",function(){k.selectToolbarImage()});a("#image-picker ").on("click","img",function(){k.addImageFromUrl(a(this).attr("src"));a("#image-picker").hide()});a("#save-canvas").on("click",function(){k.saveCanvasAjax()});a("#show-help").on("click",function(){a("#dialog-help").show()});a("#dialog-help").on("click",function(){a("#dialog-help").hide()});a("#history").on("click",".delete",function(b){b.preventDefault();k.deleteAttempt(a(this))}).on("click",".restore",function(b){b.preventDefault();k.restoreAttempt(a(this))});a("#emoji-picker").on("click","img",function(){k.loadEmojiCsv(a(this).attr("src"));a("#emoji-picker").hide()});a("#change_background").on("click",function(){k.showFileuploader("background")});a("#add_toolbar_images").on("click",function(){k.showFileuploader("toolbar_shape")});a("#canvas-filepicker-form-student_image").on("click","#id_submitbutton",function(a){a.preventDefault();k.addUserImage()});a(".dialog").on("click",".btn-secondary",function(b){b.preventDefault();f.log("Cancel");a(".dialog").hide()})},loadEmojiPicker:function loadEmojiPicker(){var b=a("#emoji-picker");if(""!==b.html()){f.log("Toggle emoji");b.toggle();return}a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"emoji",data:{id:c.id}},dataType:"json",success:function success(a){f.log(a);if(a.success){b.html(a.html).show()}}})},loadArrowToCanvas:function loadArrowToCanvas(){fabric.loadSVGFromURL("pix/arrow.svg",function(a,b){var c=fabric.util.groupSVGElements(a,b);j.add(c.scale(.1)).centerObject(c).renderAll();c.setCoords();j.setActiveObject(c)})},setColor:function setColor(a){var b=a.toHexString(),c=j.getActiveObjects();if(c){for(var d in c){if(c.hasOwnProperty(d)){var e=c[d];if(e.hasOwnProperty("id")&&"ruler"===e.id){continue}e.set("fill",b)}}j.renderAll()}else{f.log("No active items")}},preventMovingOutOfCanvas:function preventMovingOutOfCanvas(){j.on("object:moving",function(a){var b=a.target;if(b.currentHeight>b.canvas.height||b.currentWidth>b.canvas.width){return}b.setCoords();if(0>b.getBoundingRect().top||0>b.getBoundingRect().left){b.top=Math.max(b.top,b.top-b.getBoundingRect().top);b.left=Math.max(b.left,b.left-b.getBoundingRect().left)}if(b.getBoundingRect().top+b.getBoundingRect().height>b.canvas.height||b.getBoundingRect().left+b.getBoundingRect().width>b.canvas.width){b.top=Math.min(b.top,b.canvas.height-b.getBoundingRect().height+b.top-b.getBoundingRect().top);b.left=Math.min(b.left,b.canvas.width-b.getBoundingRect().width+b.left-b.getBoundingRect().left)}})},keyboardActions:function keyboardActions(){a(document).keydown(function(a){f.log("keypress",a.which);switch(a.which){case 46:k.deleteSelectedCanvasItems();break;}})},init:function init(){this.__canvas=j=new fabric.Canvas("sketch");a("body").on("contextmenu","canvas , img",function(){return!1});j.setHeight(this.canvasHeight);j.setWidth(this.canvasWidth-70);j.on({"selection:created":this.onchange,"selection:updated":this.onchange,"object:added":this.addToCache,"object:removed":this.addToCache,"object:modified":this.addToCache});localStorage.clear();this.preventMovingOutOfCanvas();this.loadToolbar();if(c.hasHorizontalRuler){this.addHorizontalRuler()}this.loadHistory();this.keyboardActions()},addToCache:function addToCache(){f.log("history");k.addCanvasToCacheBuffer()},addCanvasToCacheBuffer:function addCanvasToCacheBuffer(){if(!h){return}clearTimeout(0);setTimeout(function(){try{g++;localStorage.setItem("buffer_"+g,JSON.stringify(j))}catch(a){f.log(a)}},500)},addHorizontalRuler:function addHorizontalRuler(){var b=new fabric.Rect({width:this.canvasWidth,height:2,id:"ruler",left:0,top:410,angle:0,fill:"#8b58a1"});b.flipY=!1;b.lockMovementX=!0;b.lockScalingX=!0;b.lockScalingY=!0;b.lockUniScaling=!0;b.lockRotation=!0;j.add(b);j.renderAll();a(document).keydown(function(a){switch(a.which){case 38:b.top=b.top-10;j.renderAll();break;case 40:b.top=b.top+10;j.renderAll();break;default:return;}a.preventDefault()})},onchange:function onchange(b){if(b.target.hasOwnProperty("id")&&"ruler"===b.target.id){return}a("#colorpicker").spectrum("set",b.target.fill)}};return{initialise:function initialise(b){a.getScript(M.cfg.wwwroot+"/mod/gcanvas/javascript/spectrum.js").done(function(){d(b);i(c.debugjs);a.noConflict();a(document).ready(function(){f.log("Canvas Module v1.2");k.init()})}).fail(function(a,b,c){f.log(a);f.log(b);f.log(c)})}}});
//# sourceMappingURL=canvas.min.js.map
