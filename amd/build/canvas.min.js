define(["jquery","core/notification"],function(a,t){"use strict";var i={id:0,debugjs:!1,hasHorizontalRuler:!0,background:""},n={},o=0,c=!0,r=null,s={canvasWidth:800,canvasHeight:500,defaultShaperect:{width:70,height:70,left:200,top:50,angle:0,fill:"#ffb628"},defaultShapecircle:{radius:40,left:200,top:50,fill:"#b3cc2b"},defaultShapetriangle:{top:50,left:200,width:70,height:70,fill:"#0081b4"},defaultShapetextbox:{top:50,left:200,fill:"#0081b4"},loadHistory:function(){a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"load_history",data:{id:i.id}},dataType:"json",success:function(e){n.log(e),e.success&&a("#history").html(e.html)},error:function(e){n.error(e.responseText),t.addNotification({message:e.responseText,type:"error"})}})},saveCanvasAjax:function(){fabric.Canvas.supports("toDataURL")?a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"save_canvas",data:{id:i.id,status:"final",canvas_data:r.toDataURL({multiplier:1,format:"png"}),json_data:JSON.stringify(r)}},dataType:"json",success:function(e){n.log(e),e.success?(t.addNotification({message:M.util.get_string("javascript:updated","mod_gcanvas"),type:"success"}),s.loadHistory()):t.addNotification({message:e.error,type:"error"})},error:function(e){n.error(e.responseText),t.addNotification({message:e.responseText,type:"error"})}}):t.addNotification({message:"This browser doesn't provide means to serialize canvas to an image",type:"error"})},deleteSelectedCanvasItems:function(){try{var e=r.getActiveObjects();if(e.length<=0)return void n.log("Selection empty");for(var t in e)if(e.hasOwnProperty(t)){var o=e[t];if(void 0!==o.id&&"ruler"===o.id){n.log("Ruler: Not removable!");continue}r.remove(o)}r.discardActiveObject().renderAll()}catch(e){n.error("Nothing selected",e)}},loadDynamicToolbarMappingShapes:function(){a("#toolbar .icon[data-element-type]").on("click",function(){var e,t=a(this).data("element-type");try{r.discardActiveObject()}catch(e){}var o="defaultShape"+t.toLowerCase();n.log("Search for shape: "+o),s.hasOwnProperty(o)?(n.log("Shape found"),e="Textbox"===t?new fabric[t]("DEMO",s[o]):new fabric[t](s[o]),r.add(e),r.setActiveObject(e)):n.error("Shape not found!"),r.renderAll()})},loadColorPicker:function(){a("#colorpicker").spectrum({showPalette:!0,palette:[],showSelectionPalette:!0,selectionPalette:["red","green","blue","orange"],flat:!1,change:function(e){n.log("change color"),s.setColor(e)}}).on("dragstart.spectrum , dragstop.spectrum",function(e,t){n.log("change color - dragstop - dragstart"),s.setColor(t)})},loadEmojiCsv:function(e){n.log("loadEmojiCsv : ",e),fabric.Image.fromURL(e.replace(".png",".svg"),function(e){e.set({height:500,width:500,left:150,top:100,angle:0,centerTransform:!0}).scale(.4).setCoords(),r.add(e),r.setActiveObject(e)})},deleteAttempt:function(e){n.log("Delete",e),t.confirm(M.util.get_string("javascript:confirm_title","mod_gcanvas"),M.util.get_string("javascript:confirm_desc","mod_gcanvas"),M.util.get_string("javascript:yes","mod_gcanvas"),M.util.get_string("javascript:no","mod_gcanvas"),function(){a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"delete_attempt",data:{id:i.id,attempt_id:e.data("id")}},dataType:"json",success:function(e){n.log(e),e.success?s.loadHistory():t.addNotification({message:e.error,type:"error"})},error:function(e){n.error(e.responseText),t.addNotification({message:e.responseText,type:"error"})}})})},restoreAttempt:function(e){n.log("Restore",e),a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"get_attempt",data:{id:i.id,attempt_id:e.data("id")}},dataType:"json",success:function(e){n.log(e),e.success&&(c=!1,r.loadFromJSON(e.record.json_data,r.renderAll.bind(r)),setTimeout(function(){c=!0},1e3))}})},showFileuploader:function(e){a("#canvas-filepicker-form-"+e).toggle()},setBackgroundImage:function(){""!==i.background&&fabric.Image.fromURL(i.background,function(e){r.setBackgroundImage(e,r.renderAll.bind(r),{scaleX:r.width/e.width,scaleY:r.height/e.height})})},addUserImage:function(){var o={id:i.id},e=a("#canvas-filepicker-form-student_image form").serializeArray();a.each(e,function(e,t){o[t.name]=t.value}),a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"upload_images",data:o},dataType:"json",success:function(e){n.log(e),e.success&&s.addImageFromUrl(e.image),a("#canvas-filepicker-form-student_image").hide()}})},addImageFromUrl:function(e){fabric.Image.fromURL(e,function(e){e.set({left:150,top:100,angle:0,centerTransform:!0}).setCoords();var t=r.getWidth()/3;e.width>t&&e.scaleToWidth(t),r.add(e),r.setActiveObject(e)})},selectToolbarImage:function(){var t=a("#image-picker");t.is(":visible")?t.hide():(t.show(),a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"get_toolbar_images",data:{id:i.id}},dataType:"json",success:function(e){if(n.log(e),e.success){var o='<ul class="list-group">';a.each(e.images,function(e,t){o+='<li class="toolbar-image" rel="'+e+'"><img  alt="" src="'+t+'" class="img-thumbnail"></li>'}),o+="</ul>",t.html(o)}}}))},undo:function(){if(0!==o)try{var e=localStorage.getItem("buffer_"+o);r.loadFromJSON(e,r.renderAll.bind(r)),localStorage.removeItem("buffer_"+o),o--}catch(e){n.log(e)}},loadToolbar:function(){this.setBackgroundImage(),this.loadDynamicToolbarMappingShapes(),this.loadColorPicker(),a("#clear").on("click",function(){r.clear(),i.hasHorizontalRuler&&s.addHorizontalRuler(),s.setBackgroundImage()}),a("#arrow i").on("click",function(){s.loadArrowToCanvas()}),a("#trash i").on("click",function(){s.deleteSelectedCanvasItems()}),a("#smiley i").on("click",function(){s.loadEmojiPicker()}),a("#undo").on("click",function(){c=!1,s.undo(),setTimeout(function(){c=!0},500)}),a("#add-image i").on("click",function(){s.showFileuploader("student_image")}),a("#select-a-image i").on("click",function(){s.selectToolbarImage()}),a("#image-picker ").on("click","img",function(){s.addImageFromUrl(a(this).attr("src")),a("#image-picker").hide()}),a("#save-canvas").on("click",function(){s.saveCanvasAjax()}),a("#show-help").on("click",function(){a("#dialog-help").show()}),a("#dialog-help").on("click",function(){a("#dialog-help").hide()}),a("#history").on("click",".delete",function(e){e.preventDefault(),s.deleteAttempt(a(this))}).on("click",".restore",function(e){e.preventDefault(),s.restoreAttempt(a(this))}),a("#emoji-picker").on("click","img",function(){s.loadEmojiCsv(a(this).attr("src")),a("#emoji-picker").hide()}),a("#change_background").on("click",function(){s.showFileuploader("background")}),a("#add_toolbar_images").on("click",function(){s.showFileuploader("toolbar_shape")}),a("#canvas-filepicker-form-student_image").on("click","#id_submitbutton",function(e){e.preventDefault(),s.addUserImage()}),a(".dialog").on("click",".btn-secondary",function(e){e.preventDefault(),n.log("Cancel"),a(".dialog").hide()})},loadEmojiPicker:function(){var t=a("#emoji-picker");if(""!==t.html())return n.log("Toggle emoji"),void t.toggle();a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"emoji",data:{id:i.id}},dataType:"json",success:function(e){n.log(e),e.success&&t.html(e.html).show()}})},loadArrowToCanvas:function(){fabric.loadSVGFromURL("pix/arrow.svg",function(e,t){var o=fabric.util.groupSVGElements(e,t);r.add(o.scale(.1)).centerObject(o).renderAll(),o.setCoords(),r.setActiveObject(o)})},setColor:function(e){var t=e.toHexString(),o=r.getActiveObjects();if(o){for(var a in o)if(o.hasOwnProperty(a)){var i=o[a];if(i.hasOwnProperty("id")&&"ruler"===i.id)continue;i.set("fill",t)}r.renderAll()}else n.log("No active items")},preventMovingOutOfCanvas:function(){r.on("object:moving",function(e){var t=e.target;t.currentHeight>t.canvas.height||t.currentWidth>t.canvas.width||(t.setCoords(),(t.getBoundingRect().top<0||t.getBoundingRect().left<0)&&(t.top=Math.max(t.top,t.top-t.getBoundingRect().top),t.left=Math.max(t.left,t.left-t.getBoundingRect().left)),(t.getBoundingRect().top+t.getBoundingRect().height>t.canvas.height||t.getBoundingRect().left+t.getBoundingRect().width>t.canvas.width)&&(t.top=Math.min(t.top,t.canvas.height-t.getBoundingRect().height+t.top-t.getBoundingRect().top),t.left=Math.min(t.left,t.canvas.width-t.getBoundingRect().width+t.left-t.getBoundingRect().left)))})},keyboardActions:function(){a(document).keydown(function(e){switch(n.log("keypress",e.which),e.which){case 46:s.deleteSelectedCanvasItems()}})},init:function(){this.__canvas=r=new fabric.Canvas("sketch"),a("body").on("contextmenu","canvas , img",function(){return!1}),r.setHeight(this.canvasHeight),r.setWidth(this.canvasWidth-70),r.on({"selection:created":this.onchange,"selection:updated":this.onchange,"object:added":this.addToCache,"object:removed":this.addToCache,"object:modified":this.addToCache}),localStorage.clear(),this.preventMovingOutOfCanvas(),this.loadToolbar(),i.hasHorizontalRuler&&this.addHorizontalRuler(),this.loadHistory(),this.keyboardActions()},addToCache:function(){n.log("history"),s.addCanvasToCacheBuffer()},addCanvasToCacheBuffer:function(){c&&(clearTimeout(0),setTimeout(function(){try{o++,localStorage.setItem("buffer_"+o,JSON.stringify(r))}catch(e){n.log(e)}},500))},addHorizontalRuler:function(){var t=new fabric.Rect({width:this.canvasWidth,height:2,id:"ruler",left:0,top:410,angle:0,fill:"#8b58a1"});t.flipY=!1,t.lockMovementX=!0,t.lockScalingX=!0,t.lockScalingY=!0,t.lockUniScaling=!0,t.lockRotation=!0,r.add(t),r.renderAll(),a(document).keydown(function(e){switch(e.which){case 38:t.top=t.top-10,r.renderAll();break;case 40:t.top=t.top+10,r.renderAll();break;default:return}e.preventDefault()})},onchange:function(e){e.target.hasOwnProperty("id")&&"ruler"===e.target.id||a("#colorpicker").spectrum("set",e.target.fill)}};return{initialise:function(e){a.getScript(M.cfg.wwwroot+"/mod/gcanvas/javascript/spectrum.js").done(function(){!function(e){var t,o;for(t in i)i.hasOwnProperty(t)&&e.hasOwnProperty(t)&&("boolean"==(o=typeof i[t])?i[t]=Boolean(e[t]):"number"==o?i[t]=Number(e[t]):"string"==o&&(i[t]=String(e[t])))}(e),function(e){if(e)for(var t in console)"function"==typeof console[t]&&(n[t]=console[t].bind(window.console));else for(var o in console)"function"==typeof console[o]&&(n[o]=function(){})}(i.debugjs),a.noConflict(),a(document).ready(function(){n.log("Canvas Module v1.2"),s.init()})}).fail(function(e,t,o){n.log(e),n.log(t),n.log(o)})}}});