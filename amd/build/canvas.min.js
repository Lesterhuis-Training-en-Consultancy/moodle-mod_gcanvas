define(["jquery","core/notification","mod_gcanvas/spectrum","mod_gcanvas/fabric"],function(a,b,c,d){"use strict";var e={id:0,debugjs:!1,has_horizontal_ruler:!0,background:""},f=function(a){var b,c;for(b in e)e.hasOwnProperty(b)&&a.hasOwnProperty(b)&&(c=typeof e[b],"boolean"===c?e[b]=Boolean(a[b]):"number"===c?e[b]=Number(a[b]):"string"===c&&(e[b]=String(a[b])))},g={},h=function(a){if(a)for(var b in console)"function"==typeof console[b]&&(g[b]=console[b].bind(window.console));else for(var b in console)"function"==typeof console[b]&&(g[b]=function(){})},i=null,j={canvas_width:800,canvas_height:500,default_shape_rect:{width:70,height:70,left:200,top:50,angle:0,fill:"#ffb628"},default_shape_circle:{radius:40,left:200,top:50,fill:"#b3cc2b"},default_shape_triangle:{top:50,left:200,width:70,height:70,fill:"#0081b4"},default_shape_textbox:{top:50,left:200,fill:"#0081b4"},load_history:function(){a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"load_history",data:{id:e.id}},dataType:"json",success:function(b){g.log(b),b.success&&a("#history").html(b.html)},error:function(a){g.error(a.responseText),b.addNotification({message:a.responseText,type:"error"})}})},save_canvas_ajax:function(){d.Canvas.supports("toDataURL")?a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"save_canvas",data:{id:e.id,status:"final",canvas_data:i.toDataURL({multiplier:1,format:"png"}),json_data:JSON.stringify(i)}},dataType:"json",success:function(a){g.log(a),a.success?(b.addNotification({message:M.util.get_string("javascript:updated","mod_gcanvas"),type:"success"}),j.load_history()):b.addNotification({message:a.error,type:"error"})},error:function(a){g.error(a.responseText),b.addNotification({message:a.responseText,type:"error"})}}):b.addNotification({message:"This browser doesn't provide means to serialize canvas to an image",type:"error"})},delete_selected_canvas_items:function(){try{var a=i.getActiveObjects();if(a.length){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];if(void 0!==c.id&&"ruler"===c.id){g.log("Ruler: Not removable!");continue}i.remove(c)}i.discardActiveObject().renderAll()}else g.log("Selection empty")}catch(d){g.error("Nothing selected",d)}},load_dynamic_toolbar_mapping_shapes:function(){a("#toolbar .icon[data-element-type]").on("click",function(){var b,c=a(this).data("element-type");try{i.discardActiveObject()}catch(e){}var f="default_shape_"+c.toLowerCase();g.log("Search for shape: "+f),j.hasOwnProperty(f)?(g.log("Shape found"),b="Textbox"===c?new d[c]("DEMO",j[f]):new d[c](j[f]),i.add(b),i.setActiveObject(b)):g.error("Shape not found!"),i.renderAll()})},load_color_picker:function(){a("#colorpicker").spectrum({showPalette:!0,palette:[],showSelectionPalette:!0,selectionPalette:["red","green","blue","orange"],flat:!1,change:function(a){g.log("change color"),j.set_color(a)}}).on("dragstart.spectrum , dragstop.spectrum",function(a,b){g.log("change color - dragstop - dragstart"),j.set_color(b)})},load_emoji_csv:function(a){g.log("load_emoji_csv : ",a),d.Image.fromURL(a.replace(".png",".svg"),function(a){a.set({height:500,width:500,left:150,top:100,angle:0,centerTransform:!0}).scale(.4).setCoords(),i.add(a),i.setActiveObject(a)})},delete_attempt:function(c){g.log("Delete",c),b.confirm(M.util.get_string("javascript:confirm_title","mod_gcanvas"),M.util.get_string("javascript:confirm_desc","mod_gcanvas"),M.util.get_string("javascript:yes","mod_gcanvas"),M.util.get_string("javascript:no","mod_gcanvas"),function(){a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"delete_attempt",data:{id:e.id,attempt_id:c.data("id")}},dataType:"json",success:function(a){g.log(a),a.success?j.load_history():b.addNotification({message:a.error,type:"error"})},error:function(a){g.error(a.responseText),b.addNotification({message:a.responseText,type:"error"})}})})},restore_attempt:function(b){g.log("Restore",b),a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"get_attempt",data:{id:e.id,attempt_id:b.data("id")}},dataType:"json",success:function(a){g.log(a),a.success&&i.loadFromJSON(a.record.json_data,i.renderAll.bind(i))}})},show_fileuploader:function(b){a("#canvas-filepicker-form-"+b).toggle()},set_background_image:function(){""!==e.background&&d.Image.fromURL(e.background,function(a){i.setBackgroundImage(a,i.renderAll.bind(i),{scaleX:i.width/a.width,scaleY:i.height/a.height})})},add_user_image:function(){var b={id:e.id},c=a("#canvas-filepicker-form-student_image form").serializeArray();a.each(c,function(a,c){b[c.name]=c.value}),a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"upload_images",data:b},dataType:"json",success:function(b){g.log(b),b.success&&j.add_image_from_url(b.image),a("#canvas-filepicker-form-student_image").hide()}})},add_image_from_url:function(a){d.Image.fromURL(a,function(a){a.set({left:150,top:100,angle:0,centerTransform:!0}).setCoords();var b=i.getWidth()/3;a.width>b&&a.scaleToWidth(b),i.add(a),i.setActiveObject(a)})},select_toolbar_image:function(){var b=a("#image-picker");return b.is(":visible")?void b.hide():(b.show(),void a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"get_toolbar_images",data:{id:e.id}},dataType:"json",success:function(c){if(g.log(c),c.success){var d='<ul class="list-group">';a.each(c.images,function(a,b){d+='<li class="toolbar-image" rel="'+a+'"><img  alt="" src="'+b+'" class="img-thumbnail"></li>'}),d+="</ul>",b.html(d)}}}))},load_toolbar:function(){this.set_background_image(),this.load_dynamic_toolbar_mapping_shapes(),this.load_color_picker(),a("#clear").on("click",function(){i.clear(),e.has_horizontal_ruler&&j.add_horizontal_ruler(),j.set_background_image()}),a("#arrow i").on("click",function(){j.load_arrow_to_canvas()}),a("#trash i").on("click",function(a){j.delete_selected_canvas_items()}),a("#smiley i").on("click",function(){j.load_emoji_picker()}),a("#add-image i").on("click",function(){j.show_fileuploader("student_image")}),a("#select-a-image i").on("click",function(){j.select_toolbar_image()}),a("#image-picker ").on("click","img",function(){j.add_image_from_url(a(this).attr("src")),a("#image-picker").hide()}),a("#save-canvas").on("click",function(){j.save_canvas_ajax()}),a("#show-help").on("click",function(){a("#dialog-help").show()}),a("#dialog-help").on("click",function(){a("#dialog-help").hide()}),a("#history").on("click",".delete",function(b){b.preventDefault(),j.delete_attempt(a(this))}).on("click",".restore",function(b){b.preventDefault(),j.restore_attempt(a(this))}),a("#emoji-picker").on("click","img",function(){j.load_emoji_csv(a(this).attr("src")),a("#emoji-picker").hide()}),a("#change_background").on("click",function(){j.show_fileuploader("background")}),a("#add_toolbar_images").on("click",function(){j.show_fileuploader("toolbar_shape")}),a("#canvas-filepicker-form-student_image").on("click","#id_submitbutton",function(a){a.preventDefault(),j.add_user_image()}),a(".dialog").on("click",".btn-secondary",function(b){b.preventDefault(),g.log("Cancel"),a(".dialog").hide()})},load_emoji_picker:function(){var b=a("#emoji-picker");return""!==b.html()?(g.log("Toggle emoji"),void b.toggle()):void a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"emoji",data:{id:e.id}},dataType:"json",success:function(a){g.log(a),a.success&&b.html(a.html).show()}})},load_arrow_to_canvas:function(){d.loadSVGFromURL("pix/arrow.svg",function(a,b){var c=d.util.groupSVGElements(a,b);i.add(c.scale(.1)).centerObject(c).renderAll(),c.setCoords(),i.setActiveObject(c)})},set_color:function(a){var b=a.toHexString(),c=i.getActiveObjects();if(c){for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];if(e.hasOwnProperty("id")&&"ruler"===e.id)continue;e.set("fill",b)}i.renderAll()}else g.log("No active items")},prevent_moving_out_of_canvas:function(){i.on("object:moving",function(a){var b=a.target;b.currentHeight>b.canvas.height||b.currentWidth>b.canvas.width||(b.setCoords(),(b.getBoundingRect().top<0||b.getBoundingRect().left<0)&&(b.top=Math.max(b.top,b.top-b.getBoundingRect().top),b.left=Math.max(b.left,b.left-b.getBoundingRect().left)),(b.getBoundingRect().top+b.getBoundingRect().height>b.canvas.height||b.getBoundingRect().left+b.getBoundingRect().width>b.canvas.width)&&(b.top=Math.min(b.top,b.canvas.height-b.getBoundingRect().height+b.top-b.getBoundingRect().top),b.left=Math.min(b.left,b.canvas.width-b.getBoundingRect().width+b.left-b.getBoundingRect().left)))})},keyboard_actions:function(){a(document).keydown(function(a){switch(g.log("keypress",a.which),a.which){case 46:j.delete_selected_canvas_items()}})},init:function(){this.__canvas=i=new d.Canvas("sketch"),a("body").on("contextmenu","canvas , img",function(a){return!1}),i.setHeight(this.canvas_height),i.setWidth(this.canvas_width),i.on({"selection:created":this.onchange,"selection:updated":this.onchange}),this.prevent_moving_out_of_canvas(),this.load_toolbar(),e.has_horizontal_ruler&&this.add_horizontal_ruler(),this.load_history(),this.keyboard_actions()},add_horizontal_ruler:function(){var b=new d.Rect({width:this.canvas_width,height:2,id:"ruler",left:0,top:410,angle:0,fill:"#8B58A1"});b.flipY=!1,b.lockMovementX=!0,b.lockScalingX=!0,b.lockScalingY=!0,b.lockUniScaling=!0,b.lockRotation=!0,i.add(b),i.renderAll(),a(document).keydown(function(a){switch(a.which){case 38:b.top=b.top-10,i.renderAll();break;case 40:b.top=b.top+10,i.renderAll();break;default:return}a.preventDefault()})},onchange:function(b){b.target.hasOwnProperty("id")&&"ruler"===b.target.id||a("#colorpicker").spectrum("set",b.target.fill)}};return{initialise:function(b){f(b),h(e.debugjs),a.noConflict(),a(document).ready(function(){g.log("Canvas Module v1.0"),j.init()})}}});