define(["jquery","core/notification","mod_gcanvas/spectrum","mod_gcanvas/fabric"],function(a,b,c,d){"use strict";var e={id:0,debugjs:!1,has_horizontal_ruler:!0,background:""},f=function(a){var b,c;for(b in e)e.hasOwnProperty(b)&&a.hasOwnProperty(b)&&(c=typeof e[b],"boolean"===c?e[b]=Boolean(a[b]):"number"===c?e[b]=Number(a[b]):"string"===c&&(e[b]=String(a[b])))},g={},h=0,i=0,j=!0,k=function(a){if(a)for(var b in console)"function"==typeof console[b]&&(g[b]=console[b].bind(window.console));else for(var b in console)"function"==typeof console[b]&&(g[b]=function(){})},l=null,m={canvas_width:800,canvas_height:500,default_shape_rect:{width:70,height:70,left:200,top:50,angle:0,fill:"#ffb628"},default_shape_circle:{radius:40,left:200,top:50,fill:"#b3cc2b"},default_shape_triangle:{top:50,left:200,width:70,height:70,fill:"#0081b4"},default_shape_textbox:{top:50,left:200,fill:"#0081b4"},load_history:function(){a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"load_history",data:{id:e.id}},dataType:"json",success:function(b){g.log(b),b.success&&a("#history").html(b.html)},error:function(a){g.error(a.responseText),b.addNotification({message:a.responseText,type:"error"})}})},save_canvas_ajax:function(){d.Canvas.supports("toDataURL")?a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"save_canvas",data:{id:e.id,status:"final",canvas_data:l.toDataURL({multiplier:1,format:"png"}),json_data:JSON.stringify(l)}},dataType:"json",success:function(a){g.log(a),a.success?(b.addNotification({message:M.util.get_string("javascript:updated","mod_gcanvas"),type:"success"}),m.load_history()):b.addNotification({message:a.error,type:"error"})},error:function(a){g.error(a.responseText),b.addNotification({message:a.responseText,type:"error"})}}):b.addNotification({message:"This browser doesn't provide means to serialize canvas to an image",type:"error"})},delete_selected_canvas_items:function(){try{var a=l.getActiveObjects();if(a.length){for(var b in a)if(a.hasOwnProperty(b)){var c=a[b];if(void 0!==c.id&&"ruler"===c.id){g.log("Ruler: Not removable!");continue}l.remove(c)}l.discardActiveObject().renderAll()}else g.log("Selection empty")}catch(d){g.error("Nothing selected",d)}},load_dynamic_toolbar_mapping_shapes:function(){a("#toolbar .icon[data-element-type]").on("click",function(){var b,c=a(this).data("element-type");try{l.discardActiveObject()}catch(e){}var f="default_shape_"+c.toLowerCase();g.log("Search for shape: "+f),m.hasOwnProperty(f)?(g.log("Shape found"),b="Textbox"===c?new d[c]("DEMO",m[f]):new d[c](m[f]),l.add(b),l.setActiveObject(b)):g.error("Shape not found!"),l.renderAll()})},load_color_picker:function(){a("#colorpicker").spectrum({showPalette:!0,palette:[],showSelectionPalette:!0,selectionPalette:["red","green","blue","orange"],flat:!1,change:function(a){g.log("change color"),m.set_color(a)}}).on("dragstart.spectrum , dragstop.spectrum",function(a,b){g.log("change color - dragstop - dragstart"),m.set_color(b)})},load_emoji_csv:function(a){g.log("load_emoji_csv : ",a),d.Image.fromURL(a.replace(".png",".svg"),function(a){a.set({height:500,width:500,left:150,top:100,angle:0,centerTransform:!0}).scale(.4).setCoords(),l.add(a),l.setActiveObject(a)})},delete_attempt:function(c){g.log("Delete",c),b.confirm(M.util.get_string("javascript:confirm_title","mod_gcanvas"),M.util.get_string("javascript:confirm_desc","mod_gcanvas"),M.util.get_string("javascript:yes","mod_gcanvas"),M.util.get_string("javascript:no","mod_gcanvas"),function(){a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"delete_attempt",data:{id:e.id,attempt_id:c.data("id")}},dataType:"json",success:function(a){g.log(a),a.success?m.load_history():b.addNotification({message:a.error,type:"error"})},error:function(a){g.error(a.responseText),b.addNotification({message:a.responseText,type:"error"})}})})},restore_attempt:function(b){g.log("Restore",b),a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"get_attempt",data:{id:e.id,attempt_id:b.data("id")}},dataType:"json",success:function(a){g.log(a),a.success&&l.loadFromJSON(a.record.json_data,l.renderAll.bind(l))}})},show_fileuploader:function(b){a("#canvas-filepicker-form-"+b).toggle()},set_background_image:function(){""!==e.background&&d.Image.fromURL(e.background,function(a){l.setBackgroundImage(a,l.renderAll.bind(l),{scaleX:l.width/a.width,scaleY:l.height/a.height})})},add_user_image:function(){var b={id:e.id},c=a("#canvas-filepicker-form-student_image form").serializeArray();a.each(c,function(a,c){b[c.name]=c.value}),a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"upload_images",data:b},dataType:"json",success:function(b){g.log(b),b.success&&m.add_image_from_url(b.image),a("#canvas-filepicker-form-student_image").hide()}})},add_image_from_url:function(a){d.Image.fromURL(a,function(a){a.set({left:150,top:100,angle:0,centerTransform:!0}).setCoords();var b=l.getWidth()/3;a.width>b&&a.scaleToWidth(b),l.add(a),l.setActiveObject(a)})},select_toolbar_image:function(){var b=a("#image-picker");return b.is(":visible")?void b.hide():(b.show(),void a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"get_toolbar_images",data:{id:e.id}},dataType:"json",success:function(c){if(g.log(c),c.success){var d='<ul class="list-group">';a.each(c.images,function(a,b){d+='<li class="toolbar-image" rel="'+a+'"><img  alt="" src="'+b+'" class="img-thumbnail"></li>'}),d+="</ul>",b.html(d)}}}))},undo:function(){if(0!==h)try{var a=localStorage.getItem("buffer_"+h);l.loadFromJSON(a,l.renderAll.bind(l)),localStorage.removeItem("buffer_"+h),h--}catch(b){g.log(b)}},load_toolbar:function(){this.set_background_image(),this.load_dynamic_toolbar_mapping_shapes(),this.load_color_picker(),a("#clear").on("click",function(){l.clear(),e.has_horizontal_ruler&&m.add_horizontal_ruler(),m.set_background_image()}),a("#arrow i").on("click",function(){m.load_arrow_to_canvas()}),a("#trash i").on("click",function(a){m.delete_selected_canvas_items()}),a("#smiley i").on("click",function(){m.load_emoji_picker()}),a("#undo").on("click",function(){j=!1,m.undo(),setTimeout(function(){j=!0},500)}),a("#add-image i").on("click",function(){m.show_fileuploader("student_image")}),a("#select-a-image i").on("click",function(){m.select_toolbar_image()}),a("#image-picker ").on("click","img",function(){m.add_image_from_url(a(this).attr("src")),a("#image-picker").hide()}),a("#save-canvas").on("click",function(){m.save_canvas_ajax()}),a("#show-help").on("click",function(){a("#dialog-help").show()}),a("#dialog-help").on("click",function(){a("#dialog-help").hide()}),a("#history").on("click",".delete",function(b){b.preventDefault(),m.delete_attempt(a(this))}).on("click",".restore",function(b){b.preventDefault(),m.restore_attempt(a(this))}),a("#emoji-picker").on("click","img",function(){m.load_emoji_csv(a(this).attr("src")),a("#emoji-picker").hide()}),a("#change_background").on("click",function(){m.show_fileuploader("background")}),a("#add_toolbar_images").on("click",function(){m.show_fileuploader("toolbar_shape")}),a("#canvas-filepicker-form-student_image").on("click","#id_submitbutton",function(a){a.preventDefault(),m.add_user_image()}),a(".dialog").on("click",".btn-secondary",function(b){b.preventDefault(),g.log("Cancel"),a(".dialog").hide()})},load_emoji_picker:function(){var b=a("#emoji-picker");return""!==b.html()?(g.log("Toggle emoji"),void b.toggle()):void a.ajax({type:"POST",url:M.cfg.wwwroot+"/mod/gcanvas/ajax.php",data:{sesskey:M.cfg.sesskey,action:"emoji",data:{id:e.id}},dataType:"json",success:function(a){g.log(a),a.success&&b.html(a.html).show()}})},load_arrow_to_canvas:function(){d.loadSVGFromURL("pix/arrow.svg",function(a,b){var c=d.util.groupSVGElements(a,b);l.add(c.scale(.1)).centerObject(c).renderAll(),c.setCoords(),l.setActiveObject(c)})},set_color:function(a){var b=a.toHexString(),c=l.getActiveObjects();if(c){for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];if(e.hasOwnProperty("id")&&"ruler"===e.id)continue;e.set("fill",b)}l.renderAll()}else g.log("No active items")},prevent_moving_out_of_canvas:function(){l.on("object:moving",function(a){var b=a.target;b.currentHeight>b.canvas.height||b.currentWidth>b.canvas.width||(b.setCoords(),(b.getBoundingRect().top<0||b.getBoundingRect().left<0)&&(b.top=Math.max(b.top,b.top-b.getBoundingRect().top),b.left=Math.max(b.left,b.left-b.getBoundingRect().left)),(b.getBoundingRect().top+b.getBoundingRect().height>b.canvas.height||b.getBoundingRect().left+b.getBoundingRect().width>b.canvas.width)&&(b.top=Math.min(b.top,b.canvas.height-b.getBoundingRect().height+b.top-b.getBoundingRect().top),b.left=Math.min(b.left,b.canvas.width-b.getBoundingRect().width+b.left-b.getBoundingRect().left)))})},keyboard_actions:function(){a(document).keydown(function(a){switch(g.log("keypress",a.which),a.which){case 46:m.delete_selected_canvas_items()}})},init:function(){this.__canvas=l=new d.Canvas("sketch"),a("body").on("contextmenu","canvas , img",function(a){return!1}),l.setHeight(this.canvas_height),l.setWidth(this.canvas_width),l.on({"selection:created":this.onchange,"selection:updated":this.onchange,"object:added":this.add_to_cache,"object:removed":this.add_to_cache,"object:modified":this.add_to_cache}),localStorage.clear(),this.prevent_moving_out_of_canvas(),this.load_toolbar(),e.has_horizontal_ruler&&this.add_horizontal_ruler(),this.load_history(),this.keyboard_actions()},add_to_cache:function(){g.log("history"),m.add_canvas_to_cache_buffer()},add_canvas_to_cache_buffer:function(){j&&(clearTimeout(i),setTimeout(function(){try{h++,localStorage.setItem("buffer_"+h,JSON.stringify(l))}catch(a){g.log(a)}},500))},add_horizontal_ruler:function(){var b=new d.Rect({width:this.canvas_width,height:2,id:"ruler",left:0,top:410,angle:0,fill:"#8B58A1"});b.flipY=!1,b.lockMovementX=!0,b.lockScalingX=!0,b.lockScalingY=!0,b.lockUniScaling=!0,b.lockRotation=!0,l.add(b),l.renderAll(),a(document).keydown(function(a){switch(a.which){case 38:b.top=b.top-10,l.renderAll();break;case 40:b.top=b.top+10,l.renderAll();break;default:return}a.preventDefault()})},onchange:function(b){b.target.hasOwnProperty("id")&&"ruler"===b.target.id||a("#colorpicker").spectrum("set",b.target.fill)}};return{initialise:function(b){f(b),k(e.debugjs),a.noConflict(),a(document).ready(function(){g.log("Canvas Module v1.0"),m.init()})}}});